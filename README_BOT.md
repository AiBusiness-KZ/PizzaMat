# 🍕 PizzaMat - Telegram Bot Integration

## ✅ РЕАЛИЗОВАНО

### 🤖 Telegram Бот (Aiogram 3.x)

Полностью функциональный Telegram бот со следующими возможностями:

#### Для клиентов:
- ✅ **Регистрация** - автоматическая регистрация через /start (телефон, имя, город)
- ✅ **Меню** - просмотр каталога через Telegram WebApp
- ✅ **Заказы** - оформление заказов, просмотр истории
- ✅ **Чеки** - загрузка фото чека с AI валидацией
- ✅ **Поддержка** - обратная связь с менеджером
- ✅ **Многоязычность** - украинский, английский, русский

#### Для менеджеров:
- ✅ **Уведомления** - автоматические уведомления о новых заказах
- ✅ **Управление** - подтверждение/отклонение заказов через кнопки
- ✅ **Статистика** - полная аналитика через API
- ✅ **Отслеживание диалогов** - все взаимодействия логируются

### 📊 Система отслеживания диалогов

**ГЛАВНАЯ ОСОБЕННОСТЬ**: Менеджер имеет полный доступ к:

1. **Все входы** - когда пользователь заходит в бота
2. **Все сообщения** - что пишет пользователь
3. **Все команды** - какие команды использует
4. **Все заказы** - полная история заказов
5. **Все обращения** - диалоги с поддержкой
6. **Отказы** - где пользователь бросил процесс (FSM состояния)

### Новые таблицы БД:

- **`user_sessions`** - сессии пользователей
- **`bot_interactions`** - ВСЕ действия пользователей
- **`support_messages`** - диалоги с поддержкой
- **`bot_statistics`** - агрегированная статистика

### API Эндпоинты для аналитики:

```
GET /api/analytics/dashboard          # Общая статистика
GET /api/analytics/interactions       # История действий
GET /api/analytics/sessions           # Сессии пользователей
GET /api/analytics/support-messages   # Обращения в поддержку
GET /api/analytics/user-journey/{id}  # Полный путь пользователя
GET /api/analytics/daily-stats        # Ежедневная статистика
```

## 🚀 Быстрый старт

### 1. Создайте Telegram бота

```bash
# 1. Найдите @BotFather в Telegram
# 2. /newbot - создайте бота
# 3. Скопируйте токен
```

### 2. Создайте канал для менеджеров

```bash
# 1. Создайте приватный канал
# 2. Добавьте бота как администратора
# 3. Получите ID канала через @getidsbot
```

### 3. Настройте .env

```env
# Добавьте в .env файл:
BOT_TOKEN=your_bot_token_from_botfather
MANAGER_CHANNEL_ID=-1001234567890
ADMIN_TELEGRAM_IDS=123456789,987654321

# Опционально (для AI валидации чеков):
N8N_URL=http://localhost:5678
N8N_WEBHOOK_SECRET=your_secret
OPENAI_API_KEY=sk-your-key-here
```

### 4. Запустите проект

```bash
# Запустить ВСЕ сервисы (Backend, Frontend, Database, Bot)
docker-compose up -d

# Проверить статус
docker-compose ps

# Логи бота
docker logs -f pizzamat_bot

# Остановить
docker-compose down
```

### 5. Применить миграции БД

```bash
# Войти в контейнер backend
docker exec -it pizzamat_backend bash

# Применить миграции (создаст таблицы для отслеживания)
alembic upgrade head
```

## 📱 Использование бота

### Команды пользователя:

- `/start` - Регистрация / Приветствие
- `/menu` - Открыть каталог (WebApp)
- `/orders` - Мои заказы
- `/support` - Связаться с поддержкой
- `/help` - Помощь

### Команды менеджера (в канале):

При новом заказе бот отправляет сообщение с кнопками:
- ✅ **Подтвердить** - подтвердить заказ
- ❌ **Отклонить** - отклонить заказ

## 📊 Просмотр статистики менеджером

### Через API:

```bash
# Дашборд за последние 7 дней
curl http://localhost:8000/api/analytics/dashboard?days=7

# Пример ответа:
{
  "users": {
    "total": 1523,
    "new": 45,
    "active": 234
  },
  "sessions": {
    "total": 890,
    "avg_duration_seconds": 342
  },
  "orders": {
    "created": 156,
    "paid": 142,
    "completed": 138,
    "cancelled": 4,
    "conversion_rate": 88.46
  },
  "engagement": {
    "menu_views": 456,
    "top_commands": {
      "/menu": 456,
      "/orders": 123,
      "/support": 45
    }
  }
}
```

### User Journey (путь пользователя):

```bash
# Получить ВСЕ действия конкретного пользователя
curl http://localhost:8000/api/analytics/user-journey/123456789?days=30

# Вернет:
{
  "user": {...},
  "sessions": [
    {
      "start": "2025-10-29T10:00:00Z",
      "duration": 342,
      "messages": 15,
      "commands": 5
    }
  ],
  "interactions": [
    {
      "timestamp": "2025-10-29T10:00:05Z",
      "type": "command",
      "command": "/start",
      "response": "Регистрация успешна"
    },
    {
      "timestamp": "2025-10-29T10:01:00Z",
      "type": "command",
      "command": "/menu",
      "response": "Открыл WebApp"
    }
  ],
  "orders": [...],
  "support_messages": [...]
}
```

### Диалоги пользователя:

```bash
# Все взаимодействия пользователя
curl http://localhost:8000/api/analytics/interactions?telegram_id=123456789&days=7

# Вернет каждое сообщение, команду, клик по кнопке!
```

## 🏗️ Архитектура

```
┌─────────────────────────────────────────────────────────┐
│                    TELEGRAM API                         │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│              AIOGRAM 3.x BOT                            │
│  ┌──────────────────────────────────────────────────┐   │
│  │  SessionTrackingMiddleware                       │   │
│  │  ├─ Создает UserSession                          │   │
│  │  └─ Отслеживает длительность, активность         │   │
│  └──────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────┐   │
│  │  AuthMiddleware                                  │   │
│  │  ├─ Проверяет регистрацию                        │   │
│  │  └─ Загружает данные пользователя                │   │
│  └──────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────┐   │
│  │  InteractionLoggingMiddleware ⭐ КЛЮЧЕВОЕ!       │   │
│  │  ├─ Логирует КАЖДОЕ действие                     │   │
│  │  ├─ Записывает команды, сообщения, клики         │   │
│  │  ├─ Фиксирует FSM состояния                      │   │
│  │  └─ Сохраняет ошибки                              │   │
│  └──────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Handlers                                        │   │
│  │  ├─ start.py     (Регистрация FSM)               │   │
│  │  ├─ menu.py      (WebApp)                         │   │
│  │  ├─ orders.py    (Заказы, чеки)                  │   │
│  │  ├─ support.py   (Поддержка)                     │   │
│  │  └─ manager.py   (Действия менеджера)            │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│              FASTAPI BACKEND                            │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Bot API Endpoints                               │   │
│  │  ├─ POST /api/sessions          (начало сессии)  │   │
│  │  ├─ POST /api/interactions      (логирование)    │   │
│  │  ├─ POST /api/support            (сообщения)      │   │
│  │  ├─ GET  /api/users/{telegram_id}                │   │
│  │  └─ GET  /api/orders/user/{telegram_id}          │   │
│  └──────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Analytics Endpoints                             │   │
│  │  ├─ GET /api/analytics/dashboard                 │   │
│  │  ├─ GET /api/analytics/interactions              │   │
│  │  ├─ GET /api/analytics/sessions                  │   │
│  │  ├─ GET /api/analytics/support-messages          │   │
│  │  └─ GET /api/analytics/user-journey/{id}         │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│              POSTGRESQL DATABASE                        │
│  ├─ users                                               │
│  ├─ orders                                              │
│  ├─ user_sessions            ⭐ НОВОЕ                   │
│  ├─ bot_interactions         ⭐ НОВОЕ                   │
│  ├─ support_messages          ⭐ НОВОЕ                   │
│  └─ bot_statistics           ⭐ НОВОЕ                   │
└─────────────────────────────────────────────────────────┘
```

## 🔧 Опционально: n8n для AI валидации

### Что дает n8n:

1. **AI валидация чеков** через GPT-4o Vision
2. **Автоматические уведомления** менеджеру
3. **Ежедневная статистика**
4. **Интеграция с другими сервисами**

### Настройка:

1. Запустите n8n:
   ```bash
   docker run -p 5678:5678 n8nio/n8n
   ```

2. Импортируйте workflows из `n8n_workflows/`

3. Настройте credentials (OpenAI, Telegram Bot)

4. Обновите .env:
   ```env
   N8N_URL=http://localhost:5678
   OPENAI_API_KEY=sk-your-key
   ```

## 📁 Структура проекта

```
PizzaMat/
├── backend/                    # FastAPI Backend
│   ├── app/
│   │   ├── models/
│   │   │   └── bot_interaction.py    ⭐ НОВОЕ
│   │   └── routes/
│   │       ├── analytics.py          ⭐ НОВОЕ
│   │       └── bot_api.py            ⭐ НОВОЕ
│   └── alembic/versions/
│       └── 20251029_bot_tracking.py  ⭐ НОВОЕ
├── frontend/                   # React + Vite
├── telegram_bot/               ⭐ НОВОЕ
│   ├── bot.py                  # Главный файл
│   ├── config.py               # Настройки
│   ├── handlers/               # Обработчики
│   ├── keyboards/              # Клавиатуры
│   ├── states/                 # FSM состояния
│   ├── middlewares/            # Middleware (ЛОГИРОВАНИЕ)
│   ├── services/               # API клиенты
│   └── README.md               # Документация бота
├── n8n_workflows/              ⭐ НОВОЕ
│   └── README.md               # n8n документация
└── docker-compose.yml          # Обновлен (добавлен bot)
```

## 🎯 Основные возможности

### ✅ Для пользователей:
1. Регистрация через бота (1 минута)
2. Просмотр меню через WebApp
3. Заказ пиццы
4. Загрузка чека оплаты
5. Отслеживание статуса заказа
6. Обратная связь

### ✅ Для менеджера:
1. **Полная видимость** всех диалогов
2. **Статистика** по входам, заказам, отказам
3. **User Journey** - путь каждого пользователя
4. **Уведомления** о новых заказах
5. **Управление** заказами через кнопки
6. **Поддержка** - прямая связь с клиентами

## 🧪 Тестирование

### 1. Проверка бота

```bash
# Логи
docker logs -f pizzamat_bot

# Перезапуск
docker-compose restart telegram_bot
```

### 2. Проверка логирования

```bash
# Войти в БД
docker exec -it pizzamat_postgres psql -U pizzamat -d pizzamatif

# Проверить логи взаимодействий
SELECT * FROM bot_interactions
ORDER BY created_at DESC
LIMIT 10;

# Проверить сессии
SELECT * FROM user_sessions
ORDER BY session_start DESC
LIMIT 10;

# Проверить поддержку
SELECT * FROM support_messages
ORDER BY created_at DESC;
```

### 3. Тестовый сценарий

1. Найдите бота в Telegram (по username)
2. Отправьте `/start` - пройдите регистрацию
3. Нажмите `/menu` - откроется WebApp
4. Создайте заказ
5. Загрузите фото чека
6. Проверьте канал менеджера - должно прийти уведомление
7. Проверьте БД - все действия залогированы

## 📊 Примеры статистики

### Dashboard:
- Всего пользователей: 1523
- Новых за неделю: 45
- Активных за неделю: 234
- Заказов создано: 156
- Заказов завершено: 138
- Конверсия: 88.46%

### Top команды:
1. /menu - 456 раз
2. /orders - 123 раза
3. /support - 45 раз

### Funnel (воронка):
- Просмотров меню: 456
- Добавили в корзину: 234 (51%)
- Начали оформление: 178 (76%)
- Загрузили чек: 156 (88%)
- Завершили заказ: 138 (88%)

## 🐛 Troubleshooting

**Бот не запускается:**
```bash
# Проверьте логи
docker logs pizzamat_bot

# Проверьте переменные
docker exec pizzamat_bot env | grep BOT_TOKEN

# Проверьте Backend
curl http://localhost:8000/health
```

**Логирование не работает:**
```bash
# Примените миграции
docker exec -it pizzamat_backend alembic upgrade head

# Проверьте таблицы
docker exec -it pizzamat_postgres psql -U pizzamat -d pizzamatif -c "\dt"
```

**n8n не получает webhooks:**
```bash
# Проверьте доступность
curl http://localhost:5678

# Проверьте logs
docker logs n8n
```

## 📚 Документация

- **Бот**: `telegram_bot/README.md`
- **n8n**: `n8n_workflows/README.md`
- **API**: http://localhost:8000/docs (если DEBUG=true)

## 🎉 Готово!

Теперь у вас есть полностью функциональный Telegram бот с:
- ✅ Регистрацией и авторизацией
- ✅ Просмотром меню через WebApp
- ✅ Оформлением заказов
- ✅ Загрузкой чеков
- ✅ **Полным отслеживанием диалогов**
- ✅ **Статистикой для менеджера**
- ✅ Поддержкой клиентов

---

**🤖 Generated with Claude Code**
